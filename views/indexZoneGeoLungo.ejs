 <!-- indexZoneGeo.ejs -->
<%- include('layout/headerZoneGeo') %>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }
  </style>

<style>
  html, body { height: 100%; }
  #map {   height: calc(100vh - 60px);  /* 60px = altezza del footer */
  width: 100%; }
  .leaflet-container {
  z-index: 0 !important;
}
#drawer-toggle-btn {
  position: fixed;
  bottom: 6rem; /* circa 96px */
  left: 1rem;
  z-index: 3000;
}

#welcome-flash, .fade-in, #guide-toast {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
}
</style>
<style>
.drawer-side {
  z-index: 50 !important;
}
</style>

<style>
/* Forza la visualizzazione delle emoji nei marker personalizzati */
.leaflet-div-icon {
  background: none !important;
  border: none !important;
}

.leaflet-div-icon div {
  font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
  text-align: center;
}
</style>
<style>
  #group-feed {
    max-height: none !important;   /* niente limite altezza */
    overflow-y: visible !important; /* elimina scrollbar verticale */
  }
</style>
<style>
  #profile-section {
    min-height: calc(100vh - 60px); /* spazio per il footer */
    overflow-y: auto;
  }

  footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 50;
  }
</style>
<style>
#main-table {
  table-layout: fixed; /* forza larghezza colonne */
  width: 100%;
}

/* Celle e intestazioni */
#main-table th, 
#main-table td {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
  vertical-align: middle;
  font-size: 0.85rem;
  padding: 6px;
}

/* Larghezze colonne */
#main-table td:nth-child(1),
#main-table th:nth-child(1) { width: 40px; }

#main-table td:nth-child(2),
#main-table th:nth-child(2) { width: 60px; }

#main-table td:nth-child(3),
#main-table th:nth-child(3) { 
  width: 40px; 
  text-align: center; 
}

/* Bottone Delete pi√π compatto */
#main-table .btn-error {
  min-width: 24px;
  height: 24px;
  padding: 0;
}
</style>






   <!-- 1: inizio flex -->
<div class="flex flex-row h-screen">
<!-- 2: drawer -->
    <div class="drawer drawer-start">
      <input id="my-drawer" type="checkbox" class="drawer-toggle" />

      <!-- Contenuto principale (mappa) -->
      <div class="drawer-content relative">
    <!-- Pulsante toggle sempre visibile -->


      <!-- Pulsante flottante in basso a sinistra -->



          <!-- unica mappa -->
     <div id="content-sections" class="relative w-full h-full">

  <!-- üó∫Ô∏è MAPPA -->
  <div id="map-section" class="h-full">
    <div id="map" class="w-full h-full rounded-lg shadow-md"></div>
  

<!-- üî¥ Pulsante Add Point centrato sopra il footer -->
<a href="/addPoint"
   class="fixed bottom-20 left-1/2 -translate-x-1/2 z-10">
<button
    class="bg-white border border-gray-300 rounded-full p-3 shadow-lg hover:scale-110 transition-transform">
    <i class="fas fa-plus text-gray-700 text-xl"></i>
  </button>
</a>


  </div>

<!-- üï∏Ô∏è Pulsante toggle drawer (resta sopra tutto) -->
<a id="drawer-toggle-btn"
   class="fixed bottom-24 left-4 z-[3000]">
  <label for="my-drawer"
         class="bg-white border border-gray-300 rounded-full p-2 cursor-pointer text-3xl hover:scale-110 transition-transform shadow-lg">
    üï∏Ô∏è
  </label>
</a>
 <!-- üìç Pulsante geolocalizzazione -->
<button id="use-my-location"
        class="fixed bottom-24 right-4 z-[3000] bg-white border border-gray-300 rounded-full p-3 shadow-lg hover:scale-110 transition-transform">
  <i class="fas fa-crosshairs text-gray-700 text-xl"></i>
</button>

  <!-- üë§ PROFILO (inizialmente nascosto) -->
  <div id="profile-section" class="hidden bg-base-100 h-full overflow-y-auto p-6 rounded-lg shadow-md">
    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
      üë§ Mon profil
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <p><strong>Email:</strong> <%= user.email %></p>
        <p><strong>R√¥le:</strong> <%= user.role %></p>
        <p><strong>Groupe:</strong> <%= user.groupId || '‚Äî' %></p>
        <% if (referenteOffice) { %>
          <p><strong>R√©f√©rent:</strong> <%= referenteOffice.email %></p>
        <% } %>
      </div>
      <div>
        <p><strong>XP:</strong>
          <span class="badge badge-primary"><%= user.xp || 0 %></span>
        </p>
        <p><strong>Badges:</strong><br>
          <% if (user.badges && user.badges.length > 0) { %>
            <% user.badges.forEach(b => { %>
              <span class="badge badge-accent mr-1 mb-1"><%= b.name %></span>
            <% }) %>
          <% } else { %>
            <span class="text-gray-500">‚Äî</span>
          <% } %>
        </p>
      </div>
    </div>

    <div class="mt-6 flex flex-wrap gap-3">
      <a href="/indexZoneGeo?view=points" class="btn btn-outline btn-sm">
        <i class="fas fa-map-pin"></i> Mes points
      </a>
      <a href="/indexZoneParcelle" class="btn btn-outline btn-sm">
        <i class="fas fa-draw-polygon"></i> Mes parcelles
      </a>
      <a href="/logout" class="btn btn-outline btn-sm">Log out</a>
  
      <form method="POST" action="/delete_account"
          onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer votre compte ? Cette action est irr√©versible.');"
          style="display: inline;">
          <button class="btn btn-sm btn-outline-error" type="submit">
            üóëÔ∏è Supprimer mon compte
          </button>
      </form>
    </div>
  </div>
</div>
 
      </div>
      
        <!-- Sidebar- a sinistra -->
        <div class="drawer-side">
        <label for="my-drawer" class="drawer-overlay"></label>
        <aside class="w-80 bg-base-200 p-4 overflow-y-auto">
    
        <!-- üë§ Info utente -->
<!-- üë§ Info utente -->
<div class="bg-base-100 rounded-lg shadow-md p-4 mb-4 ml-20">
  <h2 class="text-lg font-bold mb-3 flex items-center gap-2">
    <i class="fas fa-user-circle text-primary"></i> Profil 
  </h2>

  <p><strong>Email:</strong> <%= user.email %></p>
  <p><strong>XP:</strong> 
    <span class="badge badge-primary"><%= user.xp || 0 %></span>
  </p>
  <p><strong>Badge:</strong>
    <% if (user.badges && user.badges.length > 0) { %>
      <% user.badges.forEach(b => { %>
        <span class="badge badge-accent mr-1 mb-1"><%= b.name %></span>
      <% }) %>
    <% } else { %>
      <span class="text-gray-500">‚Äî</span>
    <% } %>
  </p>
</div>
<!-- Aggiungi switch ‚ÄúMostra punti del gruppo‚Äù -->
<div class="form-control mb-4">
  <label class="cursor-pointer label flex items-center justify-between">
    <span class="label-text font-semibold">üë• Montrer les points du group</span>
    <input type="checkbox" id="toggleGroupPoints" class="toggle toggle-primary" />
  </label>
</div>

  <!-- üîπ Tabella dei punti con DataTables -->
<div class="mt-4 overflow-x-auto rounded-lg shadow-md bg-base-100">
  <table id="main-table" class="display stripe hover compact w-full">
    <thead>
      <tr>
        <th style="width: 80px;">Cat√©gorie</th>
        <th style="width: 180px;">Nom</th>
        <th style="width: 60px; text-align: center;">Action</th>
      </tr>
    </thead>
    <tbody>
      <% points.forEach((row) => { %>
        <tr>
          <td><%= row.category || 'Senza categoria' %></td>
          <td><%= row.name || 'Senza nom' %></td>
          <td style="text-align: center;">
            <% if (row.user && row.user._id.toString() === user._id.toString()) { %>
              <a href="/delete/<%= row._id %>" class="btn btn-xs btn-error">
                <i class="fas fa-trash"></i>
              </a>
            <% } else { %>
              <span class="text-gray-400 text-xs italic">‚Äî</span>
            <% } %>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<!-- Feed del gruppo (ajax) -->
<div id="group-feed" class="mt-4 p-2 bg-base-100 rounded shadow-sm">
  <div class="text-center text-muted">Caricamento feed...</div>
</div>

            <div id="group-feed" class="mt-4 p-2 bg-base-100 rounded shadow-sm">
                  <!-- Qui AJAX inserir√† i punti -->
                    <div class="text-center text-muted">Caricamento feed...</div>
            </div>

          <button id="closeSidebar" class="close-btn d-md-none" data-bs-toggle="collapse" data-bs-target="#sidebar">&times;</button><br>
    
        </aside>
        
    <script>
      async function loadGroupFeed() {
        try {
          const res = await fetch('/groupFeed');
          if (!res.ok) throw new Error("Errore HTTP " + res.status);
          const html = await res.text();
          const feed = document.getElementById('group-feed');
          const oldHeight = feed.scrollHeight;
          feed.innerHTML = html;
            // Scroll automatico se il contenuto √® aumentato
          if (feed.scrollHeight > oldHeight) {
            feed.scrollTop = feed.scrollHeight;
          }
        } catch (err) {
          console.error("‚ùå Errore caricamento feed:", err);
        }
      }

      document.addEventListener('DOMContentLoaded', loadGroupFeed);
      setInterval(loadGroupFeed, 30000);
    </script>



    </div>
    <!-- Fine .container-fluid -->

    <!-- Link in basso visibili sempre -->

<script>
  // ‚è≥ Mostra un messaggio di guida dopo 5 secondi
  setTimeout(() => {
    const guide = document.createElement('div');
    guide.className = "bg-blue-100 text-blue-800 px-4 py-3 rounded-xl text-center shadow-md mb-4 fade-in";
    guide.innerHTML = `
     üí° C‚Äôest √† vous de jouer !
Cliquez sur la carte pour ajouter vos premiers points üó∫Ô∏è
Apr√®s trois contributions, vous ferez officiellement partie du groupe üöÄ    `;
    document.body.prepend(guide);

    // sparisce dopo altri 10 secondi (opzionale)
    setTimeout(() => guide.remove(), 10000);
  }, 5000);
</script>
<!-- ‚ú® Toast di benvenuto dinamico solo per utenti 'field' -->
<script>
window.addEventListener("load", () => {
  if (window.user && window.user.role === "field") {
    if (!localStorage.getItem("firstVisit")) {
      showToast("üëã Benvenuto! Clicca sulla mappa per aggiungere i tuoi primi punti üó∫Ô∏è", "info");
      localStorage.setItem("firstVisit", "1");
    }
  }
});
</script>
<!-- ‚ú® Fine toast -->
<!-- üí´ FLASH MESSAGE SESSIONE (onboarding field) -->
<% if (flashMessage) { %>
  <div id="welcome-flash" class="bg-purple-100 text-purple-800 px-4 py-3 rounded-xl text-center shadow-md mb-4 animate-fadeIn">
    <%= flashMessage %>
  </div>
  <script>
    // Rimuovi dopo 6s per non restare visibile
    setTimeout(() => {
      const el = document.getElementById("welcome-flash");
      if (el) el.remove();
    }, 6000);
  </script>
<% } %>


    <script>
      var points = <%- JSON.stringify(points || []) %>;
       var currentUserId = "<%= user._id %>";  // üëà aggiungi questa riga
  window.CATEGORIES = <%- JSON.stringify(user.categories || []) %>;

      console.log("üß™ categorie dell'utente field:", window.CATEGORIES);
      console.log("üß™ categorie dell'utente field:", <%- JSON.stringify(user.categories || []) %>);
      console.log("üîé Points lato client:", <%- JSON.stringify(points || []) %>);

    </script>
    </div> <!-- üîí chiusura drawer -->
</div> <!-- üîí chiusura flex-row -->
<%- include('layout/footer') %>
<script>
  const openProfileBtn = document.getElementById('open-profile');
  const goPlanBtn = document.getElementById('go-plan');
  const mapSection = document.getElementById('map-section');
  const profileSection = document.getElementById('profile-section');

  function openProfile() {
    mapSection.classList.add('hidden');
    profileSection.classList.remove('hidden');
  }

  function closeProfile() {
    profileSection.classList.add('hidden');
    mapSection.classList.remove('hidden');
    if (window.map && typeof window.map.invalidateSize === 'function') {
      setTimeout(() => window.map.invalidateSize(), 300);
    }
  }

  if (openProfileBtn) openProfileBtn.addEventListener('click', openProfile);
  if (goPlanBtn) goPlanBtn.addEventListener('click', closeProfile);

  // ESC per chiudere il profilo
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeProfile();
  });
</script>
<script src="/js/dataAuthorGeo.js" defer></script>