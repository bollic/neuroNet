 <!-- indexZoneGeoAnon.ejs -->
<%- include('layout/headerZoneGeo') %>

<style>
  html, body { height: 100%; }
  #map { height: 100%; min-height: 80vh; }
  .leaflet-container {
  z-index: 0 !important;
}
</style>
<style>
  #group-feed {
    max-height: none !important;   /* niente limite altezza */
    overflow-y: visible !important; /* elimina scrollbar verticale */
  }
</style>

   <!-- 1: inizio flex -->
<div class="flex flex-row h-[80vh]">
<!-- 2: drawer -->
    <div class="drawer drawer-start">
      <input id="my-drawer" type="checkbox" class="drawer-toggle" />

      <!-- Contenuto principale (mappa) -->
      <div class="drawer-content relative">
    <!-- Pulsante toggle sempre visibile -->
      <a class="absolute top-4 left-4 z-50">
        <label for="my-drawer" class="btn btn-primary btn-sm shadow-lg">
          ‚ò∞ Menu
        </label>
      </a>
          <!-- unica mappa -->
        <div id="map" class="w-full h-[80vh] rounded-lg shadow-md"></div>
          <!-- Pulsante Add point -->
        <a href="<%= user ? '/addPoint' : '/addPointAnon' %>" class="absolute top-4 right-4 z-50">
          <button class="btn btn-warning btn-sm shadow-lg">
            <i class="fas fa-plus"></i> Add point
          </button>
        </a>

      </div>
      
        <!-- Sidebar- a sinistra -->
        <div class="drawer-side">
        <label for="my-drawer" class="drawer-overlay"></label>
        <aside class="w-80 bg-base-200 p-4 overflow-y-auto">
          <% if (message) { %>
            <div class="alert alert-<%= message.type || 'info' %> shadow-lg rounded-lg p-3">
              <i class="fas fa-exclamation-circle mr-2"></i>
              <strong><%= message.message %></strong>
            </div>
          <% } %>
          
          <!-- Tabella dei punti -->
          <% if (points && points.length > 0) { %>
            <div class="table table-zebra mt-4">
              <table id="main-table" class="table table-zebra w-full">
                <thead class="table-dark">
                  <tr>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <% points.forEach((row) => { %>
                    <tr>
                      <td><%= row.name %></td>
                      <td><%= row.category || 'Senza categoria' %></td>
                      <td>
                        <a href="/delete/<%= row._id %>" class="btn btn-xs btn-error">
                          <i class="fas fa-trash"></i>
                        </a>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="text-center text-secondary mt-5">
              Aucun point trouv√© dans la base de donn√©es!
            </div>
          <% } %>
            <!-- Feed del gruppo (ajax) -->
            <div id="group-feed" class="mt-4 p-2 bg-base-100 rounded shadow-sm">
                  <!-- Qui AJAX inserir√† i punti -->
                    <div class="text-center text-muted">Caricamento feed...</div>
            </div>

          <button id="closeSidebar" class="close-btn d-md-none" data-bs-toggle="collapse" data-bs-target="#sidebar">&times;</button><br>
    
        </aside>
    <script>
      async function loadGroupFeed() {
        try {
          const res = await fetch('/groupFeed');
          if (!res.ok) throw new Error("Errore HTTP " + res.status);
          const html = await res.text();
          const feed = document.getElementById('group-feed');
          const oldHeight = feed.scrollHeight;
          feed.innerHTML = html;
            // Scroll automatico se il contenuto √® aumentato
          if (feed.scrollHeight > oldHeight) {
            feed.scrollTop = feed.scrollHeight;
          }
        } catch (err) {
          console.error("‚ùå Errore caricamento feed:", err);
        }
      }

      document.addEventListener('DOMContentLoaded', loadGroupFeed);
      setInterval(loadGroupFeed, 30000);
    </script>



    </div>
    <!-- Fine .container-fluid -->

    <!-- Link in basso visibili sempre -->

    <script>
      var points = <%- JSON.stringify(points || []) %>;
       var categories = <%- JSON.stringify(categories || []) %>; // üëà usa quello passato dal server
 
      console.log("üß™ categorie dell'utente anonimo:", <%- JSON.stringify(categories || []) %>);
      console.log("üîé Points lato client:", <%- JSON.stringify(points || []) %>);

    </script>
    </div> <!-- üîí chiusura drawer -->
</div> <!-- üîí chiusura flex-row -->
<%- include('layout/footer') %>

<script src="/js/dataAuthorGeoAnon.js" defer></script>
