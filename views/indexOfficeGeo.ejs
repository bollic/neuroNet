<%- include('layout/headerOfficeGeo') %>
<style>
  html, body { height: 100%; }
  #map { height: 100%; min-height: 80vh; }
  .leaflet-container {
  z-index: 0 !important;
}
</style>
<style>
  #group-feed {
    max-height: none !important;   /* niente limite altezza */
    overflow-y: visible !important; /* elimina scrollbar verticale */
  }
</style>
  <!-- Layout principale con drawer (sidebar a sinistra + mappa a destra) -->
<div class="drawer lg:drawer-open">
  <input id="my-drawer" type="checkbox" class="drawer-toggle" />
  
  <div class="drawer-content flex flex-col">
      <!-- Messaggi -->
       <% if (message) { %>
          <div class="alert alert-<%= message.type || 'info' %> shadow-lg rounded-lg p-3">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <strong><%= message.message %></strong>
          </div>
        <% } %>
     <!-- Contenuto principale (mappa) -->
      <div class="drawer-content relative">        
          <!-- Pulsante toggle -->
        <a class="absolute top-4 left-4 z-50">
          <label for="my-drawer" class="btn btn-primary btn-sm shadow-lg">
            ‚ò∞ Menu
          </label>
        </a>
      
          <!-- Qui va la mappa -->
          <div id="map" class="w-full h-[85vh] rounded-lg shadow-md"></div>
        </div> 
     </div>

      <!-- Sidebar- a sinistra -->
  <div class="drawer-side">

  <!-- Filtri category e date-->
<div class="flex space-x-4 my-3">
  <!-- Filtro Category -->
  <select id="filter-category" class="select select-bordered">
    <option value="">Toutes le categories</option>
  </select>
  <!-- Filtro Data -->
  <input type="date" id="filter-date" class="input input-bordered" />
</div>
 <!-- Fine Filtri category e date-->
      <!-- Sidebar -->
    <label for="my-drawer" class="drawer-overlay"></label>
    <aside class="w-80 bg-base-200 p-4 overflow-y-auto">
      
      <!-- Tabella dei punti -->
      <% if (points && points.length > 0) { %>
        <div class="overflow-x-auto">
          <table id="main-table" class="table table-zebra w-full">
            <thead>
              <tr>
                <th>Name</th>
                <th>Categorie</th>
                <th>Date</th>
                <th style="display:none;">createdAtISO</th> <!-- üëà aggiunto -->
                <th>Category</th>
              </tr>
            </thead>
         <tbody>
          <!-- DataTables popoler√† qui le righe -->
        </tbody>

          </table>
        </div>
      <% } else { %>
        <div class="text-center text-secondary mt-5">
          Aucun point trouv√© dans la base de donn√©es!
        </div>
      <% } %>

      <!-- üîß Form modifica categorie globali -->
    <div class="mt-4 card bg-base-100 shadow-md">
  <div class="card-body">
    <h5 class="text-lg font-bold mb-2">Cat√©gories globali attuali:</h5>
    <p><strong><%= categories.join(', ') %></strong></p>
    <form action="/update-categories" method="POST" class="flex flex-col gap-2">
      <input type="hidden" name="userId" value="<%= user._id %>" />
      <input type="text" name="newCategories" 
             class="input input-bordered" 
             placeholder="Es: X,Y,Z" required />
      <span class="text-xs text-gray-500">Inserisci le categorie separate da virgola</span>
      <button type="submit" class="btn btn-primary w-full">
        Aggiorna categorie
      </button>
    </form>
  </div>
</div>

      
    </aside>
  </div>
</div>

<!-- Dopo aver mostrato gli utenti field e i loro form -->
<script>
  const fieldUsers = <%- JSON.stringify(fieldUsers || []) %>;
  console.log("üîç fieldUsers nel template:", fieldUsers);
</script>

<!-- Esporta i dati gi√† piatti e i fieldUsers al client -->
<script>
  // points √® gi√† l'array piatto che abbiamo creato nel controller (pointsForClient)
  window.FIELD_USERS = <%- JSON.stringify(fieldUsers || []) %>;
  window.POINTS = <%- JSON.stringify(points || []) %>; // NOTA: "points" qui √® quello che abbiamo passato col res.render
  console.log("üîç fieldUsers nel template:", window.FIELD_USERS);
  console.log("üìä POINTS (client):", window.POINTS);
</script>

<%- include('layout/footerOffice') %>

<script src="/js/dataOfficeGeo.js" defer></script>
