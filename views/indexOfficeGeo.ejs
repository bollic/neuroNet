<%- include('layout/headerOfficeGeo') %>

<style>
  html, body { height: 100%; }
  #map { height: 100%; min-height: 80vh; }
  .leaflet-container { z-index: 0 !important; }
</style>

<div class="drawer lg:drawer-open">
  <input id="my-drawer" type="checkbox" class="drawer-toggle" />
  <div class="drawer-content flex flex-col">

    <div class="drawer-content relative">        
      <a class="absolute top-4 left-4 z-50">
        <label for="my-drawer" class="btn btn-primary btn-sm shadow-lg">â˜° Menu</label>
      </a>
      <div id="map" class="w-full h-[85vh] rounded-lg shadow-md"></div>
    </div> 
  </div>

  <div class="drawer-side" style="width: 440px; flex: 0 0 440px;">
  <label for="my-drawer" class="drawer-overlay"></label>
  <aside class="w-full bg-base-200 p-4 overflow-y-auto">
    <!-- ğŸ”§ Gestione info gruppo -->
      <div class="mb-4">
        <a href="/groups"
          class="btn btn-outline btn-primary w-full">
          âœï¸ Modifier les informations du groupe
        </a>
      </div>
      <!-- Filtro -->
      <div class="flex space-x-4 my-3">
        <select id="filter-category" class="select select-bordered">
          <option value="">Tutte le categorie</option>
        </select>
        <input type="date" id="filter-date" class="input input-bordered" />
      </div>
      
      <!-- Stato piano -->
       
      <div class="my-3 p-3 bg-base-100 rounded-lg shadow-md">
  <h3 class="font-bold text-lg mb-1">Votre plan</h3>

<span class="badge <%= plan === 'free' ? 'badge-warning' : plan === 'pro' ? 'badge-success' : 'badge-primary' %>">
  <%= plan.toUpperCase() %>
</span>
<p class="text-sm mt-1">
  Limite: <%= maxPoints === Infinity ? 'illimitÃ©s ğŸš€' : maxPoints + ' points' %>
</p>

<% if (group.planExpiresAt) { %>
  <p class="text-xs text-warning">
    Demo PRO scade il: <%= new Date(group.planExpiresAt).toLocaleString() %>
  </p>
<% } %>

<% if (plan === 'free') { %>
  <form action="/pay/pro" method="POST" class="mt-3">
    <button type="submit" class="btn btn-success w-full">
     ğŸš€ DÃ©bloquer le plan Pro

    </button>
  </form>
  <p class="text-xs text-gray-500 mt-1 text-center">
  Essai Pro â€¢ aucun paiement â€¢ activation immÃ©diate
</p>
<% } else { %>
  <p class="mt-3 text-sm text-success font-medium">
    âœ… Plan Pro actif â€“ limites Ã©tendus
  </p>
<% } %>


</div>

<!-- Tabella punti (stile lista card) -->
<div class="mt-4 card bg-base-100 shadow-md">
  <div class="card-body">
    <h5 class="text-lg font-bold mb-2">Points par utilisateur</h5>
    <details class="mb-4">
  <summary class="cursor-pointer font-semibold">
    ğŸ” Gestion champ description
  </summary>
    <% pointsByField.forEach(f => { %>
  <div class="mb-4 p-3 border rounded">
    <h6 class="font-semibold">
      <%= f.email %> (<%= f.points.length %> punti)
    </h6>

    <% f.points.forEach(p => { %>
      <div class="flex items-center gap-2 ml-4 mt-2">
        <span>ğŸ“ <%= p.name %></span>

        <select
          class="select select-bordered select-sm"
          onchange="shareDescription('<%= p._id %>', this.value)">
          <option value="">Condividi conâ€¦</option>

          <% fieldUsers.forEach(u => { 
               if (u._id.toString() !== f.userId) { %>
            <option value="<%= u._id %>">
              <%= u.email %>
            </option>
          <% } }) %>
        </select>
      </div>
    <% }) %>
  </div>
<% }) %>
  
</details>
    <div class="overflow-x-auto">
      <table id="main-table" class="table table-zebra w-full">
        <thead>
          <tr>
            <th>Name</th>
            <th>Categorie</th>
            <th>Date</th>
            <th style="display:none;">createdAtISO</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

      <!-- Form categorie globali -->
      <div class="mt-4 card bg-base-100 shadow-md">
        <div class="card-body">
          <h5 class="text-lg font-bold mb-2">Categorie globali:</h5>
          <p><strong><%= categories.map(c => c.name).join(', ') %></strong></p>

          <form id="categories-form" action="/update-categories" method="POST" class="flex flex-col gap-2">
            <div id="category-list" class="flex flex-col gap-2">
              <% categories.forEach((c, i) => { %>
                <div class="flex items-center gap-2 category-row">
                  <input type="text" name="categories[<%= i %>][name]" value="<%= c.name %>" class="input input-bordered w-1/2" placeholder="Nome categoria">
                  <select name="categories[<%= i %>][icon]" class="select select-bordered w-1/3">
                    <option value="red" <%= c.icon === 'red' ? 'selected' : '' %>>ğŸ”´ Rosso</option>
                    <option value="truck" <%= c.icon === 'truck' ? 'selected' : '' %>>ğŸšš Camion</option>
                    <option value="home" <%= c.icon === 'home' ? 'selected' : '' %>>ğŸ  Casa</option>
                      <option value="custom" <%= (!['red','truck','home'].includes(c.icon) || !c.icon) ? 'selected' : '' %>>
                            âœ¨ Emoji libera
                    </option>
                  </select>
                   <input 
                      type="text" 
                      name="categories[<%= i %>][customEmoji]" 
                      value="<%= !['red','truck','home'].includes(c.icon) ? c.icon : '' %>" 
                      placeholder="ğŸ˜Š incolla qui emoji" 
                      class="input input-bordered w-1/4 text-center custom-emoji-input"
                    />
        <button type="button" class="btn btn-sm btn-ghost emoji-picker-btn">ğŸ˜„</button>
                  <button type="button" class="btn btn-error btn-sm remove-category">âœ–</button>
                </div>
              <% }) %>
            </div>

            <button type="button" id="add-category" class="btn btn-secondary btn-sm">â• Aggiungi categoria</button>
            <button type="submit" class="btn btn-primary w-full mt-2">ğŸ’¾ Salva categorie</button>
          </form>
        </div>
      </div>

    </aside>
  </div>
</div>
<script>
async function shareDescription(pointId, fieldId) {
  if (!fieldId) return;

  await fetch(`/office/points/${pointId}/visibility`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ fieldId })
  });

  alert('Description condivisa');
}
</script>

<script>
  window.FIELD_USERS = <%- JSON.stringify(fieldUsers || []) %>;
  window.POINTS = <%- JSON.stringify(points || []) %>;
  window.CATEGORIES = <%- JSON.stringify(categories || []) %>;
</script>

<%- include('layout/footerOffice') %>
<script src="/js/dataOfficeGeo.js" defer></script>
