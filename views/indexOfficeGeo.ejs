<%- include('layout/headerOfficeGeo') %>

<style>
  html, body { height: 100%; }
  #map { height: 100%; min-height: 80vh; }
  .leaflet-container { z-index: 0 !important; }
</style>

<div class="drawer lg:drawer-open">
  <input id="my-drawer" type="checkbox" class="drawer-toggle" />

  <div class="drawer-content flex flex-col">
    <% if (message) { %>
      <div class="alert alert-<%= message.type || 'info' %> shadow-lg rounded-lg p-3">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <strong><%= message.message %></strong>
      </div>
    <% } %>

    <div class="drawer-content relative">        
      <a class="absolute top-4 left-4 z-50">
        <label for="my-drawer" class="btn btn-primary btn-sm shadow-lg">‚ò∞ Menu</label>
      </a>

      <div id="map" class="w-full h-[85vh] rounded-lg shadow-md"></div>
    </div> 
  </div>

  <div class="drawer-side" style="width: 440px; flex: 0 0 440px;">
  <label for="my-drawer" class="drawer-overlay"></label>
  <aside class="w-full bg-base-200 p-4 overflow-y-auto">
      <!-- Filtro -->
      <div class="flex space-x-4 my-3">
        <select id="filter-category" class="select select-bordered">
          <option value="">Tutte le categorie</option>
        </select>
        <input type="date" id="filter-date" class="input input-bordered" />
      </div>

      <!-- Tabella -->
      <% if (points && points.length > 0) { %>
        <div class="overflow-x-auto">
          <table id="main-table" class="table table-zebra w-full">
            <thead>
              <tr>
                <th>Name</th>
                <th>Categorie</th>
                <th>Date</th>
                <th style="display:none;">createdAtISO</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      <% } else { %>
        <div class="text-center text-secondary mt-5">
          Nessun punto trovato!
        </div>
      <% } %>

      <!-- Form categorie globali -->
      <div class="mt-4 card bg-base-100 shadow-md">
        <div class="card-body">
          <h5 class="text-lg font-bold mb-2">Categorie globali:</h5>
          <p><strong><%= categories.map(c => c.name).join(', ') %></strong></p>

          <form id="categories-form" action="/update-categories" method="POST" class="flex flex-col gap-2">
            <div id="category-list" class="flex flex-col gap-2">
              <% categories.forEach((c, i) => { %>
                <div class="flex items-center gap-2 category-row">
                  <input type="text" name="categories[<%= i %>][name]" value="<%= c.name %>" class="input input-bordered w-1/2" placeholder="Nome categoria">
                  <select name="categories[<%= i %>][icon]" class="select select-bordered w-1/3">
                    <option value="red" <%= c.icon === 'red' ? 'selected' : '' %>>üî¥ Rosso</option>
                    <option value="truck" <%= c.icon === 'truck' ? 'selected' : '' %>>üöö Camion</option>
                    <option value="home" <%= c.icon === 'home' ? 'selected' : '' %>>üè† Casa</option>
                      <option value="custom" <%= (!['red','truck','home'].includes(c.icon) || !c.icon) ? 'selected' : '' %>>
                            ‚ú® Emoji libera
                    </option>
                  </select>
                   <input 
                      type="text" 
                      name="categories[<%= i %>][customEmoji]" 
                      value="<%= !['red','truck','home'].includes(c.icon) ? c.icon : '' %>" 
                      placeholder="üòä incolla qui emoji" 
                      class="input input-bordered w-1/4 text-center custom-emoji-input"
                    />
<button type="button" class="btn btn-sm btn-ghost emoji-picker-btn">üòÑ</button>
                  <button type="button" class="btn btn-error btn-sm remove-category">‚úñ</button>
                </div>
              <% }) %>
            </div>

            <button type="button" id="add-category" class="btn btn-secondary btn-sm">‚ûï Aggiungi categoria</button>
            <button type="submit" class="btn btn-primary w-full mt-2">üíæ Salva categorie</button>
          </form>
        </div>
      </div>

    </aside>
  </div>
</div>

<script>
  window.FIELD_USERS = <%- JSON.stringify(fieldUsers || []) %>;
  window.POINTS = <%- JSON.stringify(points || []) %>;
  window.CATEGORIES = <%- JSON.stringify(categories || []) %>;
</script>

<%- include('layout/footerOffice') %>
<script src="/js/dataOfficeGeo.js" defer></script>
