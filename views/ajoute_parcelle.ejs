<%- include('layout/header') %>
<p class="text-muted"> ðŸ”¹ Cliquez sur la carte pour ajouter les sommets de la parcelle.
  ðŸ”¹ AprÃ¨s au moins 3 points, le polygone sera crÃ©Ã© automatiquement.
  ðŸ”¹ Vous pouvez supprimer un marqueur en double-cliquant dessus.</p>

<div id="map" style="position: relative; width: 100%; height: 400px;"></div>

<div class="container mt-4">
  <div class="row">
    <div class="col-lg-6 mx-auto">
      <form id="add-parcelle" method="POST">
     

                <div class="mb-3">                                         
                        <label for="name">Name</label>
                        <input type="text" name="name" class="form-control form-control-lg" 
                        placeholder="Enter name" value="Default Name"  required />
                
                     <!-- Categoria -->                  
                    <select name="category" id="category" class="form-control" required>
                      <% categories.forEach(function(cat) { %>
                        <option value="<%= cat.name %>"><%= cat.icon %> - <%= cat.name %></option>
                      <% }); %>
                    </select>
       </div>  
        <input type="hidden" id="polygon" name="polygon">

        <div class="mb-3 d-grid">
          <button type="submit" class="btn btn-primary btn-lg">Salva parcella</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script defer>
document.addEventListener("DOMContentLoaded", function() {
  const map = L.map("map", { center: [46.2, 2.9], zoom: 5, tap: false });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

  const drawnItems = new L.FeatureGroup().addTo(map);
  let markers = [];

  // Aggiungi marker singolo con click
  map.on("click", function(e) {
    const marker = L.marker(e.latlng, { draggable: true }).addTo(map);
    markers.push(marker);

    marker.on("dblclick", () => {
      map.removeLayer(marker);
      markers = markers.filter(m => m !== marker);
    });

    updatePolygon();
  });

  // Aggiorna GeoJSON hidden
  function updatePolygon() {
    if (markers.length < 3) {
      document.getElementById("polygon").value = "";
      drawnItems.clearLayers();
      return;
    }
    const latlngs = markers.map(m => m.getLatLng());
    const polygon = L.polygon(latlngs);
    drawnItems.clearLayers();
    polygon.addTo(drawnItems);

    const geoJsonFeature = {
      type: "Feature",
      geometry: polygon.toGeoJSON().geometry,
      properties: {}
    };
    document.getElementById("polygon").value = JSON.stringify(geoJsonFeature);
  }

  // Submit del form
  const form = document.getElementById("add-parcelle");
  form.addEventListener("submit", async e => {
    e.preventDefault();
    const polygonValue = document.getElementById("polygon").value;
    if (!polygonValue) {
      alert("Aggiungi almeno 3 punti per creare un poligono!");
      return;
    }

    const formData = {
      name: form.name.value,
      category: form.category.value,
      polygon: polygonValue
    };

    try {
      const res = await fetch("/ajoute_parcelle", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
      });
      const data = await res.json();
      if (res.ok) {
        alert("Parcella salvata!");
        window.location.href = "/indexZoneParcelle";
      } else {
        alert(`Errore: ${data.message}`);
      }
    } catch (err) {
      console.error(err);
      alert("Errore di connessione");
    }
  });
});
</script>

<%- include('layout/footer') %>
