<%- include('layout/header') %>
<p class="text-muted"> ðŸ”¹ Cliquez sur la carte pour ajouter les sommets de la parcelle.
  ðŸ”¹ AprÃ¨s au moins 3 points, le polygone sera crÃ©Ã© automatiquement.
  ðŸ”¹ Vous pouvez supprimer un marqueur en double-cliquant dessus.</p>

<div id="map" style="position: relative; width: 100%; height: 400px;"></div>
<div class="max-w-lg mx-auto mt-4 p-4 bg-white rounded-lg shadow">
  <form id="add-parcelle" method="POST">
    <div class="mb-3"><!-- Link in basso visibili sempre -->
 <footer class="fixed bottom-0 w-full bg-white/70 backdrop-blur-sm py-4 shadow-inner z-40">
  <div class="flex flex-wrap justify-center items-center gap-3 text-center text-sm text-gray-700">

    <% if (typeof user !== "undefined" && user) { %>
      <span>
        Wellcome, <strong><%= user.email %></strong> 
        (<%= user.role %> | Group: <%= user.groupId || 'N/A'  %> )
      </span>
        <% if (typeof referenteOffice !== "undefined" && referenteOffice) { %>
          <span class="text-gray-500 text-xs">
            RÃ©fÃ©rent : <strong><%= referenteOffice.email %></strong>
          </span>
        <% } %>
    
      
      <a class="btn btn-sm btn-outline" href="/logout">Log out</a>
      <form method="POST" action="/delete_account"
            onsubmit="return confirm('ÃŠtes-vous sÃ»r de vouloir supprimer votre compte ? Cette action est irrÃ©versible.');"
            style="display: inline;">
        <button class="btn btn-sm btn-error" type="submit">
          Delete account
        </button>
      </form>
    <% } %>

    <!-- ðŸ”¹ Link utile per la home
    <a href="/pricing" class="btn btn-sm btn-primary rounded-full shadow-sm">
      ðŸ’Ž Voir les plans tarifaires
    </a> -->
  </div>
</footer>


<!-- I tuoi script personalizzati -->
<script src="/js/popupMod.js"></script>

<script>
async function updateGroupId(userId) {
  const newGroupId = document.getElementById(`groupId-${userId}`).value;

  try {
    const res = await fetch(`/users/${userId}/groupId`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ groupId: newGroupId })
    });

    if (res.ok) {
      alert('Group ID aggiornato con successo!');
    } else {
      alert('Errore durante aggiornamento');
    }
  } catch (err) {
    console.error(err);
    alert('Errore di rete');
  }
}
</script>
</body>
</html>

      <label for="name" class="block mb-1 font-medium">Name</label>
      <input type="text" name="name" class="input input-bordered w-full" placeholder="Enter name" value="Default Name" required />
    </div>

    <div class="mb-3">
      <label for="category" class="block mb-1 font-medium">Categoria</label>
      <select name="category" id="category" class="select select-bordered w-full" required>
        <% categories.forEach(function(cat) { %>
          <option value="<%= cat.name %>"><%= cat.icon %> - <%= cat.name %></option>
        <% }); %>
      </select>
    </div>

    <input type="hidden" id="polygon" name="polygon">

    <div class="mb-3">
      <button type="submit" class="btn btn-primary btn-lg">Salva parcella</button>
    </div>
  </form>
</div>


<script defer>
document.addEventListener("DOMContentLoaded", function() {
  const map = L.map("map", { center: [46.2, 2.9], zoom: 5, tap: false });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

  const drawnItems = new L.FeatureGroup().addTo(map);
  let markers = [];

  // Aggiungi marker singolo con click
  map.on("click", function(e) {
    const marker = L.marker(e.latlng, { draggable: true }).addTo(map);
    markers.push(marker);

    marker.on("dblclick", () => {
      map.removeLayer(marker);
      markers = markers.filter(m => m !== marker);
    });

    updatePolygon();
  });

  // Aggiorna GeoJSON hidden
  function updatePolygon() {
    if (markers.length < 3) {
      document.getElementById("polygon").value = "";
      drawnItems.clearLayers();
      return;
    }
    const latlngs = markers.map(m => m.getLatLng());
    const polygon = L.polygon(latlngs);
    drawnItems.clearLayers();
    polygon.addTo(drawnItems);

    const geoJsonFeature = {
      type: "Feature",
      geometry: polygon.toGeoJSON().geometry,
      properties: {}
    };
    document.getElementById("polygon").value = JSON.stringify(geoJsonFeature);
  }

  // Submit del form
  const form = document.getElementById("add-parcelle");
  form.addEventListener("submit", async e => {
    e.preventDefault();
    const polygonValue = document.getElementById("polygon").value;
    if (!polygonValue) {
      alert("Aggiungi almeno 3 punti per creare un poligono!");
      return;
    }

    const formData = {
      name: form.name.value,
      category: form.category.value,
      polygon: polygonValue
    };

    try {
      const res = await fetch("/ajoute_parcelle", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
      });
      const data = await res.json();
      if (res.ok) {
        alert("Parcella salvata!");
        window.location.href = "/indexZoneParcelle";
      } else {
        alert(`Errore: ${data.message}`);
      }
    } catch (err) {
      console.error(err);
      alert("Errore di connessione");
    }
  });
});
</script>

<%- include('layout/footer') %>
