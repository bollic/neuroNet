 <!-- indexZoneGeo.ejs -->
<%- include('layout/headerZoneGeo') %>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
 
<style>
  html, body { height: 100%; }
  #map {   height: calc(100vh - 60px);  /* 60px = altezza del footer */
  width: 100%; }
  .leaflet-container {
  z-index: 0 !important;
}
#drawer-toggle-btn {
  position: fixed;
  bottom: 6rem; /* circa 96px */
  left: 1rem;
  z-index: 3000;
}
#welcome-flash, .fade-in, #guide-toast {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
}
</style>
<style>
.drawer-side {
  z-index: 50 !important;
}
</style>
<style>
/* Forza la visualizzazione delle emoji nei marker personalizzati */
.leaflet-div-icon {
  background: none !important;
  border: none !important;
}
.leaflet-div-icon div {
  font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
  text-align: center;
}
</style>
<style>
.highlight-row {
    background-color: #ffe9a8 !important;
    transition: background-color 0.3s ease
}
</style>
<style>
  #group-feed {
    max-height: none !important;   /* niente limite altezza */
    overflow-y: visible !important; /* elimina scrollbar verticale */
  }
</style>
<style>
  #profile-section {
    min-height: calc(100vh - 60px); /* spazio per il footer */
    overflow-y: auto;
  }
  footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 50;
  }
</style>
<style>
#main-table {
  table-layout: fixed; /* forza larghezza colonne */
  width: 100%;
}
/* Celle e intestazioni */
#main-table th, 
#main-table td {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
  vertical-align: middle;
  font-size: 0.85rem;
  padding: 6px;
}
/* Larghezze colonne */
#main-table td:nth-child(1),
#main-table th:nth-child(1) { width: 40px; }

#main-table td:nth-child(2),
#main-table th:nth-child(2) { width: 60px; }

#main-table td:nth-child(3),
#main-table th:nth-child(3) { 
  width: 40px; 
  text-align: center; 
}
/* Bottone Delete pi√π compatto */
#main-table .btn-error {
  min-width: 24px;
  height: 24px;
  padding: 0;
}
</style>
   <!-- 1: inizio flex -->
<div class="flex flex-row h-screen">
<!-- 2: drawer -->
    <div class="drawer drawer-start drawer-mobile md:drawer-open">
      <input id="my-drawer" type="checkbox" class="drawer-toggle" />
      <!-- Contenuto principale (mappa) -->
      <div class="drawer-content relative">
    <!-- Pulsante toggle sempre visibile -->
     
          <!-- unica mappa -->
     <div id="content-sections" class="relative w-full h-full">
  <!-- üó∫Ô∏è MAPPA -->
  <div id="map-section" class="h-full">
    <div id="map" class="w-full h-full rounded-lg shadow-md"></div>
      <!-- üî¥ Pulsante Add Point centrato sopra il footer -->
      <a href="/addPoint"
        class="fixed bottom-20 left-1/2 -translate-x-1/2 z-10">
      <button
          class="bg-white border border-gray-300 rounded-full p-3 shadow-lg hover:scale-110 transition-transform">
          <i class="fas fa-plus text-gray-700 text-xl"></i>
        </button>
      </a>
  </div>
<!-- üï∏Ô∏è Pulsante toggle drawer (resta sopra tutto) -->
<a id="drawer-toggle-btn"
   class="fixed bottom-24 left-4 z-[3000]">
  <label for="my-drawer"
         class="bg-white border border-gray-300 rounded-full p-2 cursor-pointer text-3xl hover:scale-110 transition-transform shadow-lg">
    üï∏Ô∏è
  </label>
</a>
 <!-- üìç Pulsante geolocalizzazione -->
<button id="use-my-location"
        class="fixed bottom-24 right-4 z-[3000] bg-white border border-gray-300 rounded-full p-3 shadow-lg hover:scale-110 transition-transform">
  <i class="fas fa-crosshairs text-gray-700 text-xl"></i>
</button>
      <!-- üë§ PROFILO (inizialmente nascosto) -->
    <%- include('partials/profileSection', { user: user, referenteOffice: referenteOffice }) %>
</div>
      </div>   
        <!-- Sidebar- a sinistra -->
        <div class="drawer-side">
        <label for="my-drawer" class="drawer-overlay"></label>
        <aside class="w-80 bg-base-200 p-4 overflow-y-auto">   
      
<!-- üë§ Info utente -->
   <%- include('partials/sidebarProfile.ejs') %>
<!-- Aggiungi switch ‚ÄúMostra punti del gruppo‚Äù -->
   <%- include('partials/sidebarToggleGroupPoints.ejs') %>
<!-- Badge piano e limite punti -->
<div class="my-3 p-3 bg-base-100 rounded-lg shadow-md">
  <h3 class="font-bold text-lg mb-1">Votre plan</h3>
  <% if (plan === "free") { %>
    <span class="badge badge-warning">FREE</span>
  <% } else if (plan === "pro") { %>
    <span class="badge badge-success">PRO</span>
  <% } else { %>
    <span class="badge badge-primary">ENTERPRISE</span>
  <% } %>
  <p class="text-sm mt-1">Limite punti per field: <%= pointLimit %></p>
</div>
  <!-- üîπ Tabella dei punti con DataTables -->
  <%- include('partials/tablePoints') %>
  <!-- Feed del gruppo -->

          <button id="closeSidebar" class="close-btn d-md-none" data-bs-toggle="collapse" data-bs-target="#sidebar">&times;</button><br>   
        </aside>        
    <script>
    // tolto async function loadGroupFeed 
    </script>
    </div>
    <!-- Fine .container-fluid -->

<!-- ‚ú® Toast di benvenuto dinamico solo per utenti 'field' -->

<!-- ‚ú® Fine toast -->
<!-- üí´ FLASH MESSAGE SESSIONE (onboarding field) -->

    <script>
      const points = <%- JSON.stringify(points || []) %>;
       var currentUserId = "<%= user._id %>";  // üëà aggiungi questa riga
      window.CATEGORIES = <%- JSON.stringify(categories || []) %>;
      console.log("üß™ categorie dell'utente field:", window.CATEGORIES);
      console.log("üß™ categorie dell'utente field:", <%- JSON.stringify(categories || []) %>);
      console.log("üîé Points lato client:", <%- JSON.stringify(points || []) %>);
    </script>
    </div> <!-- üîí chiusura drawer -->
</div> <!-- üîí chiusura flex-row -->
<%- include('layout/footer') %>

<script>
  const openProfileBtn = document.getElementById('open-profile');
  const goPlanBtn = document.getElementById('go-plan');
  const mapSection = document.getElementById('map-section');
  const profileSection = document.getElementById('profile-section');

  function openProfile() {
    mapSection.classList.add('hidden');
    profileSection.classList.remove('hidden');
  }

  function closeProfile() {
    profileSection.classList.add('hidden');
    mapSection.classList.remove('hidden');
    if (window.map && typeof window.map.invalidateSize === 'function') {
      setTimeout(() => window.map.invalidateSize(), 300);
    }
  }

  if (openProfileBtn) openProfileBtn.addEventListener('click', openProfile);
  if (goPlanBtn) goPlanBtn.addEventListener('click', closeProfile);

  // ESC per chiudere il profilo
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeProfile();
  });
</script>

<script type="module" src="/js/dataAuthorGeo.js" defer></script>
