<%- include('layout/headerZoneParcelle') %>

<style>
  html, body { height: 100%; }
  #map { height: 100%; min-height: 80vh; }
  .leaflet-container {
  z-index: 0 !important;
}
</style>
<style>
  #group-feed {
    max-height: none !important;   /* niente limite altezza */
    overflow-y: visible !important; /* elimina scrollbar verticale */
  }
</style>

   <!-- 1: inizio flex -->
<div class="flex flex-row h-[80vh]">
<!-- 2: drawer -->
    <div class="drawer drawer-start">
      <input id="my-drawer" type="checkbox" class="drawer-toggle" />

      <!-- Contenuto principale (mappa) -->
      <div class="drawer-content relative">
    <!-- Pulsante toggle sempre visibile -->
      <a class="absolute top-4 left-4 z-50">
        <label for="my-drawer" class="btn btn-primary btn-sm shadow-lg">
          ☰ Menu
        </label>
      </a>
          <!-- unica mappa -->
        <div id="map" class="w-full h-[80vh] rounded-lg shadow-md"></div>
            <!-- Pulsante flottante Add parcelle -->
        <a href="/addParcelle" class="absolute top-4 right-4 z-50">
          <button class="btn btn-warning btn-sm shadow-lg">
            <i class="fas fa-plus"></i>  Ajouter une parcelle
          </button>
        </a>
      </div>
      
        <!-- Sidebar- a sinistra -->
        <div class="drawer-side">
        <label for="my-drawer" class="drawer-overlay"></label>
        <aside class="w-80 bg-base-200 p-4 overflow-y-auto">
          <% if (message) { %>
            <div class="alert alert-<%= message.type || 'info' %> shadow-lg rounded-lg p-3">
              <i class="fas fa-exclamation-circle mr-2"></i>
              <strong><%= message.message %></strong>
            </div>
          <% } %>
        <!-- Tabella parcelles -->    
  <% if (parcelles && parcelles.length > 0) { %>
    <div class="overflow-x-auto">
     <!-- AGGIUNGI id="main-table" QUI -->
   <table id="main-table" class="table table-zebra w-full"> 
     <thead class="table-dark">
         <tr>
            <th>Numero</th>
            <th>Name</th>           
             <th>Action</th>
          </tr>
        </thead>
        <tbody>
<% parcelles.forEach((parcelle, index) => { %>
  <% const coordinates = parcelle.geometry.coordinates[0] || []; %>
  <% coordinates.forEach((coord, i) => { %>
    <tr>
      <td><%= i + 1 %></td>
      <td><%= parcelle.name %></td>     
      <td> 
      <a href="/delete-point/<%= parcelle._id %>?lat=<%= coord[1] %>&lng=<%= coord[0] %>" class="btn btn-sm btn-outline-danger">
         <i class="fas fa-trash"></i>
       </a>
      </td>
    </tr>
  <% }) %>
<% }) %>

        </tbody>
      </table>
    </div>
  <% } else { %>
    <div class="text-center text-secondary mt-5">
               Aucune parcelle trouvée dans la base de données!
            </div>
  <% } %>
      
        <!-- Feed (come in indexZoneGeo, opzionale) -->
        <div id="group-feed" class="mt-4 p-2 bg-base-100 rounded shadow-sm">
          <div class="text-center text-muted">Caricamento feed...</div>
        </div>
      </aside>
    </div>
  </div>
</div>


<script>
  // Variabile JS usata dal client
  const parcelles = <%- JSON.stringify(parcelles || []) %>;

  // Caricamento dinamico del feed (come in indexZoneGeo)
  async function loadGroupFeed() {
    try {
      const res = await fetch('/groupFeed');
      if (!res.ok) throw new Error("Errore HTTP " + res.status);
      const html = await res.text();
      const feed = document.getElementById('group-feed');
      const oldHeight = feed.scrollHeight;
      feed.innerHTML = html;
      if (feed.scrollHeight > oldHeight) {
        feed.scrollTop = feed.scrollHeight;
      }
    } catch (err) {
      console.error("❌ Errore caricamento feed:", err);
    }
  }
  document.addEventListener('DOMContentLoaded', loadGroupFeed);
  setInterval(loadGroupFeed, 30000);
</script>

<%- include('layout/footer') %>

<script src="/js/dataAuthorParcelle.js" defer></script>